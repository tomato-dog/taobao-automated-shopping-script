# æ·˜å®æŠ¢è´­è„šæœ¬
import os
import datetime
import time
from selenium import webdriver
from selenium.webdriver.edge.service import Service
from selenium.webdriver.edge.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import *

# ==== æ ¸å¿ƒé…ç½®ï¼ˆå¿…é¡»æ‰‹åŠ¨é€‚é…ï¼‰====
BUY_TIME = "2026-01-15 13:20:00"  # æŠ¢è´­æ—¶é—´ï¼ï¼ï¼
DRIVER_PATH = "C:\\Users\\fqgg\\Desktop\\msedgedriver.exe"  # Edgeé©±åŠ¨è·¯å¾„ï¼Œè‡ªè¡Œä¿®æ”¹ï¼ï¼ï¼
# ã€æ‰‹åŠ¨æŠ“ä½ å½“å‰é¡µé¢çš„å…ƒç´ é€‰æ‹©å™¨ã€‘
SELECT_ALL_XPATH ="//*[@id='cart-operation-fixed']/div[1]/label/span[2]"  # æ­¥éª¤è§ä¸‹æ–‡,å·²æŠ“å–tbçš„å…¨é€‰/ç»“ç®—/æäº¤ï¼ï¼ï¼
SETTLE_XPATH = "//*[@id='settlementContainer_1']/div[4]/div/div[2]"
SUBMIT_XPATH = "//*[@id='submitOrder']/div/div[2]/div/div[2]/div"

RETRY_TIMES = 300
OPERATE_DELAY = 0.3

# ==== åˆå§‹åŒ– ====
buy_time = datetime.datetime.strptime(BUY_TIME, '%Y-%m-%d %H:%M:%S')
now = datetime.datetime.now()
if now >= buy_time:
    print("âŒ æ—¶é—´å·²è¿‡ï¼")
    exit(0)

options = Options()
options.add_argument('--no-sandbox')
options.add_argument('--disable-blink-features=AutomationControlled')
options.add_argument('user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0')
driver = webdriver.Edge(service=Service(DRIVER_PATH, log_path=os.devnull), options=options)
driver.maximize_window()
driver.implicitly_wait(5)


# ==== ç™»å½•ï¼ˆæ‰‹åŠ¨ç¡®è®¤ï¼‰====
def login():
    driver.get("https://cart.taobao.com/cart.htm")
    print("ğŸ“± ç™»å½•ååœ¨ç»ˆç«¯æŒ‰å›è½¦ç»§ç»­...")
    input()
    print("âœ… ç™»å½•æˆåŠŸï¼")


# ==== æ‰‹åŠ¨æŠ“å…ƒç´ çš„æ­¥éª¤====
def get_element_xpath():
    print("\nğŸ“Œ è¯·æ‰‹åŠ¨è·å–ä»¥ä¸‹å…ƒç´ çš„XPATHï¼š")
    print("1. è´­ç‰©è½¦å…¨é€‰æŒ‰é’®ï¼šå³é”®å…¨é€‰æŒ‰é’® â†’ æ£€æŸ¥ â†’ å³é”®Elementsé¢æ¿ä¸­çš„å¯¹åº”å…ƒç´  â†’ Copy â†’ Copy XPATH")
    print("2. è´­ç‰©è½¦ç»“ç®—æŒ‰é’®ï¼šåŒä¸Šï¼Œå³é”®ç»“ç®—æŒ‰é’®å¤åˆ¶XPATH")
    print("3. è®¢å•é¡µæäº¤æŒ‰é’®ï¼šå…ˆæ‰‹åŠ¨ç‚¹ç»“ç®—è¿›å…¥è®¢å•é¡µï¼Œå†å³é”®æäº¤æŒ‰é’®å¤åˆ¶XPATH")
    print("\nè¯·å°†å¤åˆ¶çš„XPATHåˆ†åˆ«ç²˜è´´åˆ°é…ç½®ä¸­çš„ SELECT_ALL_XPATHã€SETTLE_XPATHã€SUBMIT_XPATH")
    input("ç²˜è´´å®ŒæˆåæŒ‰å›è½¦ç»§ç»­...")


# ==== å€’è®¡æ—¶ ====
def countdown():
    while True:
        now = datetime.datetime.now()
        diff = (buy_time - now).total_seconds()
        if diff <= 0.5:
            print("â° æŠ¢è´­å¼€å§‹ï¼")
            break
        elif diff <= 60:
            print(f"âŒ› å€’è®¡æ—¶ï¼š{int(diff)}ç§’")
            time.sleep(1)
        else:
            print(f"âŒ› è¿˜æœ‰{int(diff//60)}åˆ†{int(diff%60)}ç§’")
            time.sleep(10)
            driver.refresh()
            time.sleep(1)


# ==== æ ¸å¿ƒæŠ¢è´­====
def rush_buy():
    print("âš¡ å¼€å§‹æŠ¢è´­...")
    success = False
    for attempt in range(1, RETRY_TIMES + 1):
        try:
            now = datetime.datetime.now()
            if now < buy_time:
                continue
            
            print(f"\nğŸ“Œ ç¬¬{attempt}æ¬¡å°è¯• | {now.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}")
            
            # 1. å…¨é€‰ï¼ˆç”¨ä½ æ‰‹åŠ¨æŠ“çš„é€‰æ‹©å™¨ï¼‰
            try:
                all_select = WebDriverWait(driver, 2).until(
                    EC.element_to_be_clickable((By.XPATH, SELECT_ALL_XPATH))
                )
                if not all_select.is_selected():
                    all_select.click()
                    time.sleep(OPERATE_DELAY)
                print("âœ… å…¨é€‰æˆåŠŸ")
            except:
                print("âš ï¸ å…¨é€‰å¤±è´¥ï¼Œé‡è¯•")
                driver.refresh()
                time.sleep(1)
                continue
            
            # 2. ç»“ç®—ï¼ˆç”¨ä½ æ‰‹åŠ¨æŠ“çš„é€‰æ‹©å™¨ï¼‰
            try:
                settle_btn = WebDriverWait(driver, 2).until(
                    EC.element_to_be_clickable((By.XPATH, SETTLE_XPATH))
                )
                driver.execute_script("arguments[0].click();", settle_btn)
                time.sleep(OPERATE_DELAY)
                print("âœ… ç»“ç®—æˆåŠŸ")
            except:
                print("âš ï¸ ç»“ç®—å¤±è´¥ï¼Œé‡è¯•")
                driver.get("https://cart.taobao.com/cart.htm")
                time.sleep(1)
                continue
            
            # 3. æäº¤è®¢å•ï¼ˆç”¨ä½ æ‰‹åŠ¨æŠ“çš„é€‰æ‹©å™¨ï¼‰
            try:
                submit_btn = WebDriverWait(driver, 3, poll_frequency=0.1).until(
                    EC.element_to_be_clickable((By.XPATH, SUBMIT_XPATH))
                )
                driver.execute_script("arguments[0].click();", submit_btn)
                print("ğŸ‰ æäº¤æˆåŠŸï¼ç«‹å³æ”¯ä»˜ï¼")
                success = True
                break
            except:
                print("âš ï¸ æäº¤å¤±è´¥ï¼Œé‡è¯•")
                driver.get("https://buy.tmall.com/order/confirm_order.htm")
                time.sleep(1)
        
        except Exception as e:
            print(f"âš ï¸ å¼‚å¸¸ï¼š{str(e)[:50]}")
            driver.get("https://cart.taobao.com/cart.htm")
            time.sleep(1)
    
    if not success:
        print("\nâŒ æŠ¢è´­ç»“æŸ")
    driver.quit()


# ==== æ‰§è¡Œ====
if __name__ == "__main__":
    login()
    get_element_xpath()  # å…ˆæ‰‹åŠ¨æŠ“å…ƒç´ 
    countdown()
    rush_buy()
